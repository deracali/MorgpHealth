<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Report</title>

  <link rel="icon" type="image/x-icon" href="../assets/morgp-logo.png" />
  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    /* Custom Styles */
    .watermark-container {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 10;
      color: rgba(0, 0, 0, 0.1);
      font-size: 50px;
      font-family: 'Manrope', sans-serif;
      text-align: center;
    }

    .table-cell {
      text-align: center;
      padding: 10px;
    }

    .bold-text {
      font-weight: bold;
    }

    .section-title {
      font-size: 16px;
      font-weight: bold;
      text-align: center;
      margin: 10px 0;
    }

    .footer-note {
      font-style: italic;
      font-size: 12px;
      color: #777;
    }

    .signature-row {
      display: flex;
      justify-content: space-around;
      margin-top: 15px;
    }

    .signature-block {
      text-align: center;
    }

    .signature-text {
      font-weight: bold;
    }

    .no-data-text {
      text-align: center;
      padding: 20px;
      color: gray;
    }
    body {
    font-family: Arial, sans-serif;
    background-color: #f4f4f4;
    margin: 0;
    padding: 20px;
}

.lab-report {
    max-width: 800px;
    background: white;
    padding: 20px;
    margin: auto;
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    border-radius: 8px;
}

header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 2px solid #0073e6;
    padding-bottom: 10px;
    margin-bottom: 20px;
}

header h1 {
    color: #0073e6;
}

.school-info {
    text-align: right;
    font-size: 14px;
}

.student-info {
    display: flex;
    justify-content: space-between;
    background: #e3f2fd;
    padding: 10px;
    border-radius: 5px;
    font-size: 14px;
    margin-bottom: 20px;
}

.abstract, .materials, .procedure, .lab-result {
    margin-bottom: 20px;
}

h3 {
    background: #0073e6;
    color: white;
    padding: 8px;
    border-radius: 5px;
}

.materials-procedure {
    display: flex;
    justify-content: space-between;
}

.materials, .procedure {
    width: 48%;
}

ul, ol {
    padding-left: 20px;
}

table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
}

th, td {
    border: 1px solid #ddd;
    padding: 8px;
    text-align: center;
}

th {
    background: #0073e6;
    color: white;
}

.lab-result h4 {
    color: #0073e6;
}

.result, .discussion, .hypothesis {
    background: #e3f2fd;
    padding: 10px;
    border-radius: 5px;
    margin-top: 10px;
}
#confidential {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) rotate(-45deg);
    font-size: 5em;
    font-weight: bold;
    color: rgba(255, 0, 0, 0.2); /* Semi-transparent red */
    pointer-events: none; /* Makes sure it doesn't interfere with user interactions */
    user-select: none; /* Prevent text selection */
    z-index: 10;
}

  </style>
</head>

<body>
  <div class="lab-report">
    <header>
        <h1>LAB REPORT</h1>
        <div class="school-info">
            <h2 id="hospitalName1"></h2>
            <p id="doctorAdd">123 Street Avenue, Cityville</p>
            <p>NY 10055</p>
        </div>
    </header>

    <section class="student-info">
        <div><strong>Patient Name:</strong> <span id="patientName">Mark Anthony</span></div>
        <div><strong>Age:</strong> <span id="age">30</span></div>
        <div><strong>Gender:</strong> <span id="gender">Male</span></div>
        <div><strong>DATE:</strong> <span id="collectedOn">May 25, 2028</span></div>
    </section>

    <section class="abstract">
        <h3>ABSTRACT</h3>
        <p id="notes">This lab report summarizes the results of the patient's blood tests and other diagnostic tests conducted to assess overall health and detect any potential issues such as infections or underlying conditions.</p>
    </section>

    <section class="materials-procedure">
        <div class="materials">
            <h3>MATERIALS</h3>
            <ul>
                <li>Blood sample</li>
                <li>Urine sample</li>
                <li>X-Ray Imaging</li>
                <li>Medical equipment for diagnostic tests</li>
            </ul>
        </div>
        <div class="procedure">
            <h3>PROCEDURE</h3>
            <ol>
                <li>Blood sample collected for testing various health markers.</li>
                <li>Urine sample provided for analysis of kidney function and other parameters.</li>
                <li>X-ray imaging of the chest to check for respiratory issues.</li>
                <li>Tests for identifying any bacterial or viral infections.</li>
            </ol>
        </div>
    </section>

    <section class="investigations">
        <h3>INVESTIGATIONS</h3>
        <div class="data">
            <table id="investigationsTable">
                <tr>
                    <th>TEST NAME</th>
                    <th>RESULT</th>
                    <th>REFERENCE RANGE</th>
                </tr>
            </table>
        </div>

        <div class="diagnosis">
            <h4>DIAGNOSIS</h4>
            <p id="diagnosis">The patientâ€™s blood test revealed normal cholesterol levels, but some abnormalities were noted in kidney function tests, suggesting potential renal issues that require further examination.</p>
        </div>

        <div class="discussion">
            <h4>DISCUSSION</h4>
            <p id="diagnosis">While the results are mostly normal, the kidney function test indicates a potential early-stage kidney problem. Further tests and monitoring will be necessary to ensure proper management and care.</p>
        </div>

        <div class="hypothesis">
            <h4>HYPOTHESIS</h4>
            <p id="generatedOn">Based on the tests conducted, we hypothesize that the patient may have early-stage renal issues that need attention. A more detailed diagnosis through imaging and further lab tests will be essential.</p>
        </div>

        <div id="actionButtonContainer"></div>
        <div id="confidential"></div>
    </section>
</div>





  
  <script>
    // Redirect to index.html if no token is found
    if (!localStorage.getItem('userId')) {
      window.location.href = '../index.html';
    }
  </script>



  <script src="https://js.stripe.com/v3/"></script>
  <!-- Bootstrap 5 JS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
  
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    async function fetchData() {
        const urlParams = new URLSearchParams(window.location.search);
        const appointmentId = urlParams.get("appointmentId");

        if (!appointmentId) {
            return;
        }

        try {
            const response = await fetch(`https://morgphealth.onrender.com/api/user/api/appointments/${appointmentId}`);
            const data = await response.json();
            const appointments = data.appointment;
            const timer = appointments.timer;

            if (!data) {
                return;
            }
            console.log(appointments);

            // Set the content dynamically
            document.getElementById("hospitalName1").textContent = appointments.hospitalName1 || "N/A";
            document.getElementById("patientName").textContent = appointments.userData.name || "N/A";
            document.getElementById("age").textContent = appointments.age || "N/A";
            document.getElementById("diagnosis").textContent = appointments.diagnosis || "N/A";
            document.getElementById("notes").textContent = appointments.notes || "N/A";

            const collectedOn = new Date(appointments.createdAt);
            const reportedOn = new Date(appointments.updatedAt);
            const generatedOn = new Date(appointments.updatedAt);

            document.getElementById("collectedOn").textContent = collectedOn.toLocaleString() || "N/A";

            const investigations = appointments.investigations || [];
            const investigationsTable = document.getElementById("investigationsTable");
            investigationsTable.innerHTML = `<tr><th>TEST NAME</th><th>RESULT</th><th>REFERENCE RANGE</th></tr>`;

            if (investigations.length > 0) {
                investigations.forEach((inv) => {
                    const row = document.createElement("tr");
                    row.innerHTML = `
                        <td>${inv.name || "N/A"}</td>
                        <td>${inv.result || "N/A"}</td>
                        <td>${inv.referenceRange || "N/A"}</td>
                    `;
                    investigationsTable.appendChild(row);
                });
            }

            const confidentialElement = document.getElementById("confidential");
            const actionButtonContainer = document.getElementById("actionButtonContainer");

            if (timer) {
                confidentialElement.textContent = "Confidential";
                actionButtonContainer.innerHTML = `<button id="downloadButton" class="btn btn-primary">Download</button>`;

                const downloadButton = document.getElementById("downloadButton");

                document.getElementById("downloadButton").addEventListener("click", () => {
                    // Hide the Download button while downloading the PDF
                    downloadButton.style.display = "none";

                    // Ensure the full content is captured, including the non-visible part of the page
                    html2canvas(document.body, {
                        scrollX: 0, // Set scrollX to 0
                        scrollY: 0, // Set scrollY to 0
                        useCORS: true, // Allow cross-origin resource sharing for external images
                        width: document.body.scrollWidth, // Make sure full width is captured
                        height: document.body.scrollHeight, // Capture the full height of the page
                    }).then((canvas) => {
                        const { jsPDF } = window.jspdf;
                        const pdf = new jsPDF();
                        const imgData = canvas.toDataURL("image/png");
                        const pdfWidth = pdf.internal.pageSize.getWidth();
                        const pdfHeight = (canvas.height * pdfWidth) / canvas.width;

                        pdf.addImage(imgData, "PNG", 0, 0, pdfWidth, pdfHeight);
                        pdf.save(`Lab_${appointmentId}.pdf`);

                        // Show the Download button again after the PDF is saved
                        downloadButton.style.display = "block";
                    });
                });
            } else {
                confidentialElement.textContent = "Expired";
                actionButtonContainer.innerHTML = `<button id="payButton" class="btn btn-success">Pay Now</button>`;

                document.getElementById("payButton").addEventListener("click", async () => {
    try {
        const stripePublicKey = "pk_live_51NhtaqEl2XIBlXUMdApQJTYwiewtZS3D9zTBIV4wy7w4yFT4FhGWzfWBtLd01uf3iPnLgO1FkZGOqdtc9zeZNvyJ00Y69ARZ46"; // Add your Stripe Public Key
        const stripe = Stripe(stripePublicKey); // Initialize Stripe

        const response = await fetch("https://morgphealth.onrender.com/create-intentss", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                amount: parseInt(appointments.fees) * 100, // Convert to cents
                docName: appointments.docData.name,
                docEmail: appointments.docData.email,
                userName: appointments.userData.name,
                userEmail: appointments.userData.email,
                appointmentId: appointmentId,
            }),
        });

        const session = await response.json();

        if (session.id) {
            const result = await stripe.redirectToCheckout({ sessionId: session.id });
            if (result.error) {
                console.error("Stripe Checkout Error:", result.error.message);
            }
        }
    } catch (error) {
        console.error("Payment initialization failed:", error);
    }
});
            }
        } catch (error) {
            console.error("Error fetching data:", error);
        }
    }

    document.addEventListener("DOMContentLoaded", fetchData);
</script>



</body>

</html>